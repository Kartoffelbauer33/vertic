# üöÄ VERTIC KASSENSYSTEM - KOMPLETTE ANLEITUNG

**Production-Ready Flutter + Serverpod Boulder-Hall Management System**  
**Version:** 2.1 (E-Mail-Best√§tigung Update)  
**Aktualisiert:** 2025-01-16

---

## üìã SYSTEM √úBERSICHT

### **üéØ WAS HABEN WIR GESCHAFFEN:**
- ‚úÖ **Serverpod Backend:** L√§uft auf Hetzner VPS (159.69.144.208:8080)
- ‚úÖ **Flutter Staff App:** Windows/Android/iOS mit Admin-Panel & E-Mail-Best√§tigung
- ‚úÖ **Flutter Client App:** Kunden-App f√ºr Ticket-Kauf
- ‚úÖ **PostgreSQL Database:** Vollst√§ndiges RBAC-System + E-Mail-Verification
- ‚úÖ **Docker Deployment:** Production-Ready mit Environment Variables
- ‚úÖ **Sichere Konfiguration:** Keine Klartext-Passw√∂rter in Git
- ‚úÖ **Einheitliche E-Mail-Best√§tigung:** Staff und Client verwenden gleichen Flow

### **üèóÔ∏è ARCHITEKTUR:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Flutter Client    ‚îÇ    ‚îÇ   Flutter Staff     ‚îÇ
‚îÇ   (Kunden-App)      ‚îÇ    ‚îÇ   (Personal-App)    ‚îÇ
‚îÇ   - QR-Code         ‚îÇ    ‚îÇ   - Admin Panel     ‚îÇ
‚îÇ   - Ticket kaufen   ‚îÇ    ‚îÇ   - E-Mail-Verify   ‚îÇ
‚îÇ   - E-Mail-Verify   ‚îÇ    ‚îÇ   - Scanner         ‚îÇ
‚îÇ   - Profil          ‚îÇ    ‚îÇ   - Management      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ                          ‚îÇ
          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚îÇ HTTP REST API + E-Mail Auth
                 ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                 ‚îÇ   Serverpod Server     ‚îÇ
                 ‚îÇ   159.69.144.208       ‚îÇ
                 ‚îÇ   :8080 API            ‚îÇ
                 ‚îÇ   :8081 Monitoring     ‚îÇ
                 ‚îÇ   :8082 Web Interface  ‚îÇ
                 ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚îÇ
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ  PostgreSQL   ‚îÇ
                    ‚îÇ   Database    ‚îÇ
                    ‚îÇ   test_db     ‚îÇ
                    ‚îÇ + emailVerifiedAt ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üñ•Ô∏è SERVER-DETAILS

**Provider:** Hetzner Cloud  
**Server-Typ:** CX21 (2 vCPU, 4 GB RAM, 40 GB SSD)  
**IP-Adresse:** 159.69.144.208  
**Betriebssystem:** Ubuntu 24.04.2 LTS  

### **üîê ZUGANG:**
```bash
# SSH-Zugang
ssh root@159.69.144.208

# Web-Interfaces
http://159.69.144.208:8080/     # API Server
http://159.69.144.208:8081/     # Monitoring
http://159.69.144.208/pgadmin4  # Database Management
```

### **üõ°Ô∏è FIREWALL:**
- Port 22 (SSH): Vollzugriff
- Port 80 (HTTP): Vollzugriff  
- Port 443 (HTTPS): Vollzugriff
- Port 8080 (API): Vollzugriff
- Port 5432 (PostgreSQL): Nur localhost

---

## üìß **NEUES E-MAIL-BEST√ÑTIGUNGSSYSTEM**

### **üéØ EINHEITLICHE AUTHENTIFIZIERUNG**
- ‚úÖ **Staff-User:** Echte E-Mail-Adressen + Username-Login m√∂glich
- ‚úÖ **Client-User:** E-Mail-basierte Authentifizierung (unver√§ndert)
- ‚úÖ **Gleicher Flow:** Beide Apps verwenden identische E-Mail-Best√§tigung
- ‚úÖ **Development-friendly:** Automatische Code-Einf√ºgung f√ºr Testing

### **üîÑ STAFF E-MAIL-BEST√ÑTIGUNGSFLOW:**
```
1. Admin erstellt Staff-User mit echter E-Mail
   ‚Üì
2. Server: UserInfo (blocked: true) + StaffUser (pending_verification)
   ‚Üì
3. App navigiert automatisch zur E-Mail-Best√§tigungsseite
   ‚Üì
4. Code automatisch eingef√ºgt (Development-Modus)
   ‚Üì
5. E-Mail best√§tigt ‚Üí Account aktiviert (active)
   ‚Üì
6. Login m√∂glich mit Username ODER E-Mail
```

### **üí° ENTWICKLUNGSFEATURES:**
- **Automatische Code-Einf√ºgung:** Kein manuelles Eingeben erforderlich
- **Orange Development-Hinweis:** Visueller Hinweis f√ºr Testing
- **Sofortige Navigation:** Automatische Weiterleitung zwischen Seiten
- **Flexible Login-Optionen:** Username oder E-Mail f√ºr Staff

---

## üö® KRITISCHE SICHERHEITSLEKTIONEN

### **1. GIT SUBMODULE PROBLEM**
**Problem:** `vertic_app` war als defektes Submodule registriert
**L√∂sung:**
```bash
git rm --cached vertic_app
git add vertic_app/
git commit -m "Fix broken submodule"
```

### **2. PASSWORT-SICHERHEIT**
**‚ùå NIEMALS MACHEN:**
- Klartext-Passw√∂rter in Git committen
- Produktions-Credentials in Code
- Passw√∂rter in Dokumentation schreiben

**‚úÖ KORREKTE L√ñSUNG:**
```bash
# Nur Environment Variables verwenden
password: ${POSTGRES_PASSWORD}

# .env Datei nur auf Server (nicht in Git)
echo "POSTGRES_PASSWORD=SecurePassword123" > .env

# .gitignore erweitern
echo ".env" >> .gitignore
```

### **3. E-MAIL-BEST√ÑTIGUNGSMIGRATION**
**Problem:** Serverpod Migrations scheiterten an bestehender `account_cleanup_logs` Tabelle
**L√∂sung:** Manuelle SQL-Ausf√ºhrung √ºber PgAdmin
```sql
-- Spalte hinzuf√ºgen
ALTER TABLE staff_users ADD COLUMN "emailVerifiedAt" timestamp without time zone;

-- Superuser aktivieren
UPDATE staff_users 
SET "employmentStatus" = 'active', "emailVerifiedAt" = NOW()
WHERE "employeeId" = 'superuser';
```

---

## üíª LOKALE ENTWICKLUNG

### **BACKEND ENTWICKLUNG (Leon):**

#### **Lokaler Server starten:**
```bash
cd vertic_app/vertic/vertic_server/vertic_server_server

# Dependencies installieren
flutter pub get

# Code generieren (NACH JEDER √ÑNDERUNG!)
dart run serverpod_cli generate

# Lokalen Server starten
dart run bin/main.dart

# Server l√§uft auf:
# http://localhost:8080 - API
# http://localhost:8081 - Monitoring
```

#### **E-Mail-Best√§tigungsfeatures testen:**
```bash
# 1. Staff-User mit E-Mail erstellen
# 2. Automatische Navigation zur E-Mail-Best√§tigungsseite
# 3. Code wird automatisch eingef√ºgt
# 4. E-Mail best√§tigen
# 5. Login mit Username ODER E-Mail testen
```

### **FRONTEND ENTWICKLUNG (Kollege):**

#### **Staff App entwickeln:**
```bash
cd vertic_app/vertic/vertic_project/vertic_staff_app

# Dependencies installieren
flutter pub get

# App starten (lokaler Server)
flutter run

# App starten (Staging Server)
flutter run --dart-define=USE_STAGING=true
```

#### **Neue E-Mail-Best√§tigungsfeatures:**
- ‚úÖ **EmailVerificationPage** - Automatische Code-Einf√ºgung
- ‚úÖ **Flexible Staff-Login** - Username oder E-Mail m√∂glich
- ‚úÖ **Echte E-Mail-Adressen** - Staff-Management mit realen E-Mails
- ‚úÖ **Development-Hinweise** - Orange Snackbar f√ºr Testing

---

## üåê DEPLOYMENT PROZEDUR

### **1. SICHERE VORBEREITUNG:**
```bash
# 1. Alle Passw√∂rter aus Code entfernen
# 2. Environment Variables verwenden: ${POSTGRES_PASSWORD}
# 3. .env zu .gitignore hinzuf√ºgen
# 4. E-Mail-Best√§tigungsfeatures testen
# 5. Code committen (ohne Passw√∂rter!)
git add .
git commit -m "feat: E-Mail-Best√§tigungssystem implementiert"
git push origin main
```

### **2. SERVER DEPLOYMENT:**
```bash
# Auf Server
ssh root@159.69.144.208
cd /opt/vertic

# Code aktualisieren
git pull origin main

# .env Datei pr√ºfen (nur auf Server!)
cat .env
# POSTGRES_PASSWORD=SecurePassword123

# E-Mail-System Migration (falls erforderlich)
# √úber pgAdmin: ALTER TABLE staff_users ADD COLUMN "emailVerifiedAt" timestamp;

# Docker Build & Start
cd vertic_app/vertic/vertic_server/vertic_server_server
docker-compose up -d --build

# Status pr√ºfen
docker-compose ps
docker-compose logs -f vertic-server
```

### **3. FLUTTER APPS BUILDEN:**

#### **Android APK:**
```bash
cd vertic_app/vertic/vertic_project/vertic_staff_app

# Release APK mit E-Mail-Features
flutter build apk --release --dart-define=USE_STAGING=true

# APK Location: build/app/outputs/flutter-apk/app-release.apk
```

---

## üîç MONITORING & DEBUGGING

### **E-MAIL-BEST√ÑTIGUNGSSYSTEM TESTEN:**
```bash
# 1. Staff-User erstellen
# POST /unifiedAuth/createStaffUserWithEmail

# 2. Response pr√ºfen
{
  "success": true,
  "requiresEmailVerification": true,
  "verificationCode": "STAFF_1750631298377"
}

# 3. E-Mail best√§tigen
# POST /unifiedAuth/verifyStaffEmail

# 4. Login testen (Username UND E-Mail)
# POST /unifiedAuth/staffSignInFlexible
```

### **SERVER STATUS PR√úFEN:**
```bash
# Health Check
curl http://159.69.144.208:8080/health

# E-Mail-Best√§tigungsendpoints testen
curl -X POST http://159.69.144.208:8080/unifiedAuth/createStaffUserWithEmail

# Monitoring Dashboard
http://159.69.144.208:8081
```

### **DATENBANK ZUGRIFF:**
```bash
# pgAdmin Web-Interface
http://159.69.144.208/pgadmin4
# Login: guntramschedler@gmail.com

# E-Mail-Best√§tigungsstatus pr√ºfen
SELECT "employeeId", email, "employmentStatus", "emailVerifiedAt" 
FROM staff_users;
```

---

## üöÄ TYPISCHE WORKFLOWS

### **SZENARIO 1: E-Mail-Best√§tigungsfeature (Leon)**
```bash
1. cd vertic_app/vertic/vertic_server/vertic_server_server

2. Neues Endpoint: lib/src/endpoints/unified_auth_endpoint.dart
   - createStaffUserWithEmail()
   - verifyStaffEmail()
   - staffSignInFlexible()

3. Model erweitern: lib/src/generated/staff_user.dart
   - emailVerifiedAt Feld hinzuf√ºgen

4. Code generieren: dart run serverpod_cli generate

5. Lokal testen: dart run bin/main.dart

6. Migration: ALTER TABLE staff_users ADD COLUMN "emailVerifiedAt"

7. Committen: git add . && git commit -m "feat: E-Mail-Best√§tigungssystem"

8. Deployen: git push origin main
```

### **SZENARIO 2: E-Mail-Best√§tigungsseite (Kollege)**
```bash
1. cd vertic_app/vertic/vertic_project/vertic_staff_app

2. Neue Seite: lib/pages/admin/email_verification_page.dart
   - Automatische Code-Einf√ºgung
   - Orange Development-Hinweis
   - Navigation zur√ºck nach Best√§tigung

3. Integration: lib/pages/admin/rbac_management_page.dart
   - Navigation zur E-Mail-Best√§tigungsseite
   - requiresEmailVerification Check

4. Testen: flutter run --dart-define=USE_STAGING=true

5. Committen: git add . && git commit -m "feat: E-Mail-Best√§tigungsseite"
```

---

## üîß H√ÑUFIGE PROBLEME & L√ñSUNGEN

### **‚ùå E-Mail-Best√§tigungscode nicht eingef√ºgt**
```bash
# L√∂sung: Development-Modus pr√ºfen
# 1. verificationCode in Server-Response vorhanden?
# 2. _fillDevelopmentCode() Methode aufgerufen?
# 3. Orange Snackbar sichtbar?
```

### **‚ùå "employmentStatus pending_verification"**
```bash
# L√∂sung: E-Mail best√§tigen
# 1. E-Mail-Best√§tigungsseite √∂ffnen
# 2. Code eingeben (automatisch eingef√ºgt)
# 3. "E-Mail best√§tigen" klicken
# 4. Status wird auf 'active' gesetzt
```

### **‚ùå Migration "account_cleanup_logs already exists"**
```bash
# L√∂sung: Manuelle SQL-Ausf√ºhrung
# 1. pgAdmin √∂ffnen
# 2. ALTER TABLE staff_users ADD COLUMN "emailVerifiedAt" timestamp;
# 3. Migration als erfolgreich markieren
```

---

## üìä AKTUELLER STATUS

### **‚úÖ FUNKTIONIERT:**
- Server l√§uft stabil auf Port 8080
- E-Mail-Best√§tigungssystem vollst√§ndig implementiert
- Flutter Staff App mit automatischer Code-Einf√ºgung
- Flexibler Staff-Login (Username oder E-Mail)
- Superuser Login mit 53 Permissions
- Admin Dashboard zug√§nglich
- Git Repository sicher (keine Passw√∂rter)
- Docker Container healthy

### **üéØ N√ÑCHSTE SCHRITTE:**
1. **Echte E-Mail-Versendung:** SendGrid/AWS SES Integration
2. **Code-Ablaufzeit:** Zeitbasierte Best√§tigungscodes
3. **Client App vollst√§ndig testen**
4. **SSL/HTTPS einrichten**
5. **Multi-Tenant Support** f√ºr mehrere Boulder-Hallen

---

## üîê SECURITY CHECKLIST

- ‚úÖ **Keine Klartext-Passw√∂rter in Git**
- ‚úÖ **Environment Variables verwendet**
- ‚úÖ **Git History bereinigt**
- ‚úÖ **E-Mail-Best√§tigung implementiert**
- ‚úÖ **Account-Status Management**
- ‚úÖ **Firewall korrekt konfiguriert**
- ‚úÖ **Docker Security Best Practices**
- ‚è≥ **SSL/HTTPS Zertifikat**
- ‚è≥ **Echte E-Mail-Versendung**

---

## üë• TEAM-WORKFLOWS

### **Leon (Backend):**
- Server-Status t√§glich pr√ºfen
- E-Mail-Best√§tigungsendpoints entwickeln
- Database-Migrations verwalten (manuell bei Problemen)
- API-Dokumentation aktualisieren

### **Kollege (Frontend):**
- E-Mail-Best√§tigungsseiten implementieren
- Flexible Login-Features testen
- Apps f√ºr verschiedene Plattformen builden
- User-Feedback in Features umsetzen

### **Gemeinsam:**
- E-Mail-Best√§tigungsflow testen
- W√∂chentliche Code-Reviews
- Feature-Planning
- Production-Deployments

---

## üìö WICHTIGE LINKS

### **System URLs:**
- **API:** http://159.69.144.208:8080
- **Monitoring:** http://159.69.144.208:8081
- **pgAdmin:** http://159.69.144.208/pgadmin4

### **Dokumentation:**
- **Serverpod:** https://docs.serverpod.dev/
- **Flutter:** https://docs.flutter.dev/
- **PostgreSQL:** https://www.postgresql.org/docs/

### **Repository:**
- **GitHub:** https://github.com/Kartoffelbauer33/vertic

---

## üéâ ERFOLGSFAKTOREN

1. **Systematisches Debugging:** Jedes Problem einzeln l√∂sen
2. **Security First:** Niemals Passw√∂rter in Git
3. **E-Mail-Best√§tigung:** Einheitlicher Flow f√ºr Staff und Client
4. **Environment Variables:** Alles konfigurierbar machen
5. **Manuelle Migration:** Bei Serverpod-Problemen SQL direkt ausf√ºhren
6. **Development-friendly:** Automatische Code-Einf√ºgung f√ºr Testing
7. **Team-Kommunikation:** Regelm√§√üige Updates zwischen Backend/Frontend

---

## üí∞ KOSTEN & WARTUNG

**Monatliche Kosten:**
- Hetzner CX21: ‚Ç¨5,83/Monat
- Backups: ‚Ç¨1,17/Monat
- **Gesamt:** ~‚Ç¨7/Monat

**Wartung:**
```bash
# System Updates (monatlich)
ssh root@159.69.144.208
apt update && apt upgrade -y

# Docker Cleanup (w√∂chentlich)
docker system prune -f

# Database Backup (t√§glich automatisch)
pg_dump test_db > backup_$(date +%Y%m%d).sql

# E-Mail-Best√§tigungsstatus pr√ºfen
SELECT COUNT(*) FROM staff_users WHERE "employmentStatus" = 'pending_verification';
```

---

**üöÄ IHR HABT JETZT EIN ENTERPRISE-LEVEL SYSTEM MIT E-MAIL-BEST√ÑTIGUNG!**

Das ist ein **professionelles, skalierbares und sicheres System** mit **einheitlicher E-Mail-Best√§tigung** f√ºr Staff und Client. Alle Best Practices sind implementiert!

**Bei Problemen:** Diese Anleitung durchgehen oder direkt auf Server debuggen!

## **üéä E-MAIL-BEST√ÑTIGUNGSSYSTEM ERFOLGREICH IMPLEMENTIERT:**

### **‚úÖ VOLLST√ÑNDIGE FEATURES:**
- **Echte E-Mail-Adressen** f√ºr Staff-User
- **Automatische Code-Einf√ºgung** f√ºr Development
- **Flexible Login-Optionen** (Username oder E-Mail)
- **Einheitlicher Flow** f√ºr Staff und Client
- **Account-Status Management** (pending_verification, active, etc.)
- **Development-friendly Testing** mit visuellen Hinweisen

### **üîß PRODUKTIONSBEREIT:**
- Migration erfolgreich durchgef√ºhrt
- Superuser aktiviert und funktionsf√§hig
- E-Mail-Best√§tigungsseite implementiert
- Flexible Staff-Login getestet
- Datenbank-Schema erweitert

**Das System ist jetzt bereit f√ºr echte E-Mail-Versendung und Production-Deployment! üéâ** 