# üõí POS Artikel-Management: Umfassende Roadmap

## **üìã √úbersicht**

Das Ziel ist die Erweiterung des POS-Systems um ein vollst√§ndiges Artikel-Management mit:
- **Scanner-Integration** f√ºr Barcode-Erkennung
- **Open Food Facts API** f√ºr automatische Produktdaten
- **RBAC-basierte Verwaltung** f√ºr verschiedene Benutzerrollen
- **Nahtlose Integration** in das bestehende POS-System

---

## **üéØ Funktionale Anforderungen**

### **1. Artikel-Erfassung**
- ‚úÖ **Hardware Barcode-Scanner Integration (Prim√§r)**
  - Bestehende Scanner-Hardware verwenden (1D + 2D/QR-Codes)
  - Gleiche Scanner-Logik wie im aktuellen POS-System
  - Kamera-basiertes Scannen als Fallback
  - Manuelle Barcode-Eingabe als letzte Alternative

- ‚úÖ **Open Food Facts Integration**
  - Automatische Produktdaten-Abfrage
  - Produktname, Beschreibung, Kategorie
  - N√§hrwerte, Allergene, Bilder
  - Fallback f√ºr unbekannte Produkte

- ‚úÖ **Manuelle Artikel-Erstellung**
  - Eigene Produktdaten eingeben
  - Custom Kategorien
  - Preisgestaltung und Margen

### **2. Artikel-Verwaltung**
- ‚úÖ **CRUD-Operationen** (Create, Read, Update, Delete)
- ‚úÖ **Anpassbare Kategorien-Management**
  - Bestehende Kategorien bearbeiten/l√∂schen
  - Neue Kategorien erstellen
  - Favoriten-Kategorie f√ºr wichtigste Artikel
  - Kategorie-Reihenfolge anpassbar
- ‚úÖ **Preisgestaltung und Margen**
- ‚úÖ **Lagerbestand-Tracking**
- ‚úÖ **Artikel-Aktivierung/Deaktivierung**

### **3. Integration ins POS**
- ‚úÖ **Neue Kategorie/Tab "Artikel hinzuf√ºgen"**
  - Nur sichtbar mit entsprechenden RBAC-Permissions
  - SuperUser/Admin/FacilityAdmin k√∂nnen Artikel erstellen
  - Normal Staff hat keinen Zugriff
- ‚úÖ **Live-Anzeige neuer Artikel**
- ‚úÖ **Anpassbare Kategorie-Filter**
- ‚úÖ **Favoriten-Kategorie** f√ºr h√§ufig verwendete Artikel
- ‚úÖ **Suchfunktion**
- ‚úÖ **Hardware-Scanner Integration** (gleiche Logik wie bestehendes POS)

---

## **üèóÔ∏è Technische Architektur**

### **Backend-Erweiterungen**

#### **1. Neue Datenbank-Modelle**
```yaml
# Product Model (erweitert)
Product:
  - id: int (Primary Key)
  - barcode: String? (Optional, f√ºr gescannte Artikel)
  - name: String
  - description: String?
  - category: String
  - price: double
  - cost_price: double? (Einkaufspreis)
  - margin_percentage: double?
  - stock_quantity: int?
  - min_stock_threshold: int?
  - is_active: bool
  - is_food_item: bool
  - open_food_facts_id: String? (Referenz zur API)
  - created_by_staff_id: int
  - created_at: DateTime
  - updated_at: DateTime
  - image_url: String?
  
# ProductCategory Model (neue Tabelle)
ProductCategory:
  - id: int (Primary Key)
  - name: String
  - color_hex: String
  - icon_name: String
  - is_active: bool
  - is_favorites: bool (Favoriten-Kategorie markieren)
  - is_system_category: bool (System-Kategorien vs. Custom)
  - sort_order: int
  - created_by_staff_id: int?
  - created_at: DateTime
  - updated_at: DateTime
  
# OpenFoodFactsCache Model (Cache f√ºr API-Daten)
OpenFoodFactsCache:
  - barcode: String (Primary Key)
  - cached_data: String (JSON)
  - cached_at: DateTime
  - is_valid: bool
```

#### **2. Neue Backend-Endpoints**
```yaml
# Artikel-Management
POST   /api/products                    # Neuen Artikel erstellen
GET    /api/products                    # Alle Artikel abrufen (mit Filter)
GET    /api/products/{id}               # Einzelnen Artikel abrufen
PUT    /api/products/{id}               # Artikel aktualisieren
DELETE /api/products/{id}               # Artikel l√∂schen

# Barcode & Open Food Facts
POST   /api/products/scan               # Barcode scannen und Daten abrufen
GET    /api/products/barcode/{barcode}  # Artikel per Barcode finden
POST   /api/products/openfoodfacts      # Open Food Facts Daten abrufen

# Kategorien
GET    /api/product-categories          # Alle Kategorien
POST   /api/product-categories          # Neue Kategorie erstellen
PUT    /api/product-categories/{id}     # Kategorie aktualisieren
DELETE /api/product-categories/{id}     # Kategorie l√∂schen

# Lagerbestand
PUT    /api/products/{id}/stock         # Lagerbestand aktualisieren
GET    /api/products/low-stock          # Artikel mit niedrigem Bestand
```

#### **3. Open Food Facts Integration**
```dart
class OpenFoodFactsService {
  static const String baseUrl = 'https://world.openfoodfacts.org/api/v0';
  
  Future<ProductData?> getProductByBarcode(String barcode) async {
    final response = await http.get(
      Uri.parse('$baseUrl/product/$barcode.json'),
    );
    
    if (response.statusCode == 200) {
      final data = jsonDecode(response.body);
      if (data['status'] == 1) {
        return ProductData.fromOpenFoodFacts(data['product']);
      }
    }
    return null;
  }
}

class ProductData {
  final String name;
  final String? description;
  final String? category;
  final String? imageUrl;
  final List<String> allergens;
  final Map<String, dynamic> nutritionFacts;
  
  static ProductData fromOpenFoodFacts(Map<String, dynamic> data) {
    return ProductData(
      name: data['product_name'] ?? 'Unbekanntes Produkt',
      description: data['generic_name'],
      category: data['categories']?.split(',').first.trim(),
      imageUrl: data['image_url'],
      allergens: (data['allergens_tags'] as List?)?.cast<String>() ?? [],
      nutritionFacts: data['nutriments'] ?? {},
    );
  }
}
```

### **Frontend-Erweiterungen**

#### **1. Scanner-Integration**
```dart
# Dependencies in pubspec.yaml (nur f√ºr Fallback)
dependencies:
  mobile_scanner: ^3.5.6        # Kamera-basiertes Scannen (Fallback)
  permission_handler: ^11.0.0    # Kamera-Permissions

# Scanner Service - Hardware Scanner First
class ArticleBarcodeScannerService {
  final BackgroundScannerService _hardwareScanner;
  
  // 1. Priorit√§t: Hardware Scanner verwenden
  Future<String?> scanBarcode({bool allowCamera = true}) async {
    // Hardware Scanner ist bereits aktiv
    if (_hardwareScanner.isConnected) {
      // Scanner Input √ºber bestehende Hardware-Logik abwarten
      return _waitForHardwareScanInput();
    }
    
    // 2. Fallback: Kamera Scanner
    if (allowCamera) {
      return _showCameraScannerDialog();
    }
    
    // 3. Letzter Fallback: Manuelle Eingabe
    return _showManualBarcodeInput();
  }
  
  Future<String?> _waitForHardwareScanInput() async {
    // Gleiche Logik wie im bestehenden POS-System
    // Scanner-Events √ºber BackgroundScannerService abonnieren
  }
  
  Future<String?> _showCameraScannerDialog() async {
    // Kamera-Scanner nur als Fallback
    return showDialog<String>(
      context: context,
      builder: (context) => CameraScannerDialog(),
    );
  }
}
```

#### **2. Artikel-Management UI**

**A) POS-Integration (Inline)**
```dart
# Erweiterte POS-Seite mit "+" Button f√ºr neue Artikel
Widget _buildProductGrid() {
  return GridView.builder(
    children: [
      // Bestehende Artikel
      ...existingProducts.map((product) => _buildProductCard(product)),
      
      // "+" Button f√ºr neue Artikel (nur mit Permission)
      if (hasPermission('can_create_products'))
        _buildAddProductCard(),
    ],
  );
}

Widget _buildAddProductCard() {
  return Card(
    child: InkWell(
      onTap: () => _showAddProductDialog(),
      child: Column(
        children: [
          Icon(Icons.add, size: 32),
          Text('Neuen Artikel\nhinzuf√ºgen'),
        ],
      ),
    ),
  );
}
```

**B) Admin-Dashboard Integration**
```dart
# Separate Artikel-Verwaltung im Admin-Bereich
class ProductManagementPage extends StatefulWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text('Artikel-Verwaltung')),
      body: Column(
        children: [
          _buildSearchAndFilter(),
          _buildCategoryTabs(),
          Expanded(child: _buildProductList()),
        ],
      ),
      floatingActionButton: FloatingActionButton(
        onPressed: () => _showAddProductDialog(),
        child: Icon(Icons.add),
      ),
    );
  }
}
```

#### **3. Artikel-Erstellung Dialog**
```dart
class AddProductDialog extends StatefulWidget {
  @override
  Widget build(BuildContext context) {
    return Dialog(
      child: Container(
        width: 600,
        height: 700,
        child: Column(
          children: [
            // Scanner-Bereich
            Container(
              height: 200,
              child: _buildScannerSection(),
            ),
            
            // Produktdaten-Formular
            Expanded(
              child: _buildProductForm(),
            ),
            
            // Aktions-Buttons
            _buildActionButtons(),
          ],
        ),
      ),
    );
  }
  
  Widget _buildScannerSection() {
    return Column(
      children: [
        if (_isScanning)
          Expanded(child: BarcodeScanner(onBarcodeDetected: _onBarcodeScanned))
        else
          Column(
            children: [
              Icon(Icons.qr_code_scanner, size: 64),
              ElevatedButton(
                onPressed: () => setState(() => _isScanning = true),
                child: Text('Barcode scannen'),
              ),
              TextButton(
                onPressed: () => _showManualBarcodeDialog(),
                child: Text('Barcode manuell eingeben'),
              ),
            ],
          ),
      ],
    );
  }
}
```

---

## **üîê RBAC-Integration**

### **Neue Permissions**
```yaml
# Artikel-Management Permissions
can_view_products          # Artikel anzeigen
can_create_products        # Neue Artikel erstellen
can_edit_products          # Artikel bearbeiten
can_delete_products        # Artikel l√∂schen
can_manage_categories      # Kategorien verwalten
can_view_stock_levels      # Lagerbest√§nde einsehen
can_edit_stock_levels      # Lagerbest√§nde √§ndern
can_view_product_analytics # Verkaufsstatistiken
can_scan_barcodes         # Scanner verwenden
```

### **Rollen-Zuordnung**
```yaml
SuperUser:           # Alle Permissions
FacilityAdmin:       # Alle Permissions f√ºr ihre Standorte
HallAdmin:           # Begrenzte Permissions
  - can_view_products
  - can_scan_barcodes
  - can_view_stock_levels
  
Staff:               # Minimale Permissions  
  - can_view_products
  - can_scan_barcodes (optional)
```

---

## **üì± UX/UI Konzept**

### **1. POS-Integration (Hauptfokus)**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ [Hallen-Tickets] [Vertic Universal]     ‚îÇ
‚îÇ [Produkte ‚≠ê] [Getr√§nke] [Snacks]       ‚îÇ 
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ [üçé Apfel]  [ü•§ Cola]   [üç´ Riegel] [+] ‚îÇ
‚îÇ [üçå Banane] [üßÉ Saft]   [üç™ Keks]     ‚îÇ
‚îÇ [ü•ï Karotte][üíß Wasser] [ü•ú N√ºsse]     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**"+" Button Workflow:**
1. Klick auf "+" ‚Üí Scanner-Dialog √∂ffnet sich
2. Barcode scannen ‚Üí Open Food Facts Abfrage
3. Produktdaten anzeigen ‚Üí Preis/Kategorie anpassen
4. Speichern ‚Üí Sofort im POS verf√ºgbar

### **2. Admin-Dashboard**
```
Artikel-Verwaltung
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ [üîç Suche] [üìä Kategorien] [üìà Reports] ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Produktliste:                           ‚îÇ
‚îÇ ‚òëÔ∏è Apfel (üçé) - 1.50‚Ç¨ [üìù] [üóëÔ∏è]        ‚îÇ
‚îÇ ‚òëÔ∏è Cola (ü•§) - 2.00‚Ç¨ [üìù] [üóëÔ∏è]         ‚îÇ  
‚îÇ ‚ùå Riegel (üç´) - 1.80‚Ç¨ [üìù] [üóëÔ∏è]       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ [+ Neuen Artikel hinzuf√ºgen]            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## **üöÄ Implementation Roadmap**

### **Phase 1: Foundation (1-2 Wochen)**
1. ‚úÖ **Backend-Modelle erstellen**
   - Product Model erweitern
   - ProductCategory Model
   - Migrations ausf√ºhren

2. ‚úÖ **Basis-Endpoints implementieren**
   - CRUD f√ºr Products
   - CRUD f√ºr Categories
   - RBAC-Integration

3. ‚úÖ **Scanner-Dependencies hinzuf√ºgen**
   - mobile_scanner Package
   - Permissions Setup

### **Phase 2: Scanner & API (1-2 Wochen)**
1. ‚úÖ **Open Food Facts Integration**
   - Service-Klasse erstellen
   - Cache-System implementieren
   - Error-Handling

2. ‚úÖ **Scanner-UI entwickeln**
   - Barcode-Scanner Widget
   - Manual Input Fallback
   - Permission Handling

### **Phase 3: POS-Integration (1 Woche)**
1. ‚úÖ **Inline Artikel-Erstellung**
   - "+" Button im Product Grid
   - Scanner-Dialog
   - Sofortige POS-Integration

2. ‚úÖ **UI/UX Optimierung**
   - Product Cards Design
   - Loading States
   - Error Messages

### **Phase 4: Admin-Dashboard (1-2 Wochen)**
1. ‚úÖ **Separate Artikel-Verwaltung**
   - ProductManagementPage
   - Bulk-Operations
   - Advanced Filtering

2. ‚úÖ **Analytics & Reports**
   - Verkaufsstatistiken
   - Lagerbestand-Reports
   - Popular Products

### **Phase 5: Erweiterte Features (Optional)**
1. ‚úÖ **Lagerbestand-Management**
   - Stock Tracking
   - Low Stock Alerts
   - Automatic Reordering

2. ‚úÖ **Advanced Scanner Features**
   - Batch Scanning
   - Custom Barcode Generation
   - Inventory Scanning

---

## **üí° Empfehlungen**

### **Prim√§rer Ansatz: POS-Integration**
**Warum:** 
- ‚úÖ Direkter Workflow ohne Context-Switch
- ‚úÖ Sofortige Verf√ºgbarkeit neuer Artikel
- ‚úÖ Intuitive Bedienung f√ºr Staff

**Implementierung:**
1. "+" Button in jeder Produkt-Kategorie
2. Scanner-Dialog mit Open Food Facts
3. Minimale Daten-Eingabe (nur Preis anpassen)
4. Sofort einscannen und verkaufen

### **Sekund√§rer Ansatz: Admin-Dashboard**
**Warum:**
- ‚úÖ Detaillierte Verwaltung f√ºr Admins
- ‚úÖ Bulk-Operations
- ‚úÖ Analytics und Reports

**Integration:**
- RBAC-basierte Navigation
- Separate Management-Seite
- Import/Export Funktionen

### **Hybrid-L√∂sung (Empfohlen)**
```
Staff/POS:     Schnelles Hinzuf√ºgen via Scanner
Admins:        Detaillierte Verwaltung im Dashboard
SuperUser:     Beide Optionen verf√ºgbar
```

---

## **üîß Technische √úberlegungen**

### **Performance**
- **Caching:** Open Food Facts Daten lokal speichern
- **Lazy Loading:** Produktbilder erst bei Bedarf laden
- **Pagination:** Gro√üe Produktlisten aufteilen

### **Offline-Support**
- **Local Storage:** H√§ufig verwendete Produktdaten
- **Sync:** Automatische Synchronisation bei Verbindung
- **Fallback:** Manuelle Eingabe wenn API nicht verf√ºgbar

### **Security**
- **Input Validation:** Alle Benutzereingaben validieren
- **Rate Limiting:** Open Food Facts API-Aufrufe begrenzen
- **Permissions:** Granulare RBAC-Kontrolle

### **Monitoring**
- **API Usage:** Open Food Facts Aufrufe tracken
- **Error Tracking:** Scanner-Fehler und API-Ausf√§lle
- **Performance Metrics:** Ladezeiten und User Experience

---

## **üéØ N√§chste Schritte**

1. **üìù Entscheidung treffen**: POS-Integration vs. Admin-Dashboard vs. Hybrid
2. **üóÑÔ∏è Backend erweitern**: Product Model und Endpoints implementieren
3. **üì± Scanner testen**: mobile_scanner Package integrieren
4. **üåê API Setup**: Open Food Facts Service entwickeln
5. **üé® UI Prototyp**: Scanner-Dialog und Product Cards designen

**Empfehlung:** Mit **POS-Integration** starten f√ºr sofortigen Nutzen, sp√§ter **Admin-Dashboard** f√ºr erweiterte Verwaltung hinzuf√ºgen. 